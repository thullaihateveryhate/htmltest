// generate-config.js
// Reads .env file (local dev) or process.env (Vercel) and writes Frontend/js/env.js + config.js

const fs = require('fs');
const path = require('path');

// Try reading .env file; fall back to process.env (for Vercel / CI)
const envPath = path.join(__dirname, '..', '.env');
const env = {};

if (fs.existsSync(envPath)) {
  console.log('üìÑ Reading from .env file');
  fs.readFileSync(envPath, 'utf8').split('\n').forEach(line => {
    const match = line.match(/^\s*([\w]+)\s*=\s*["']?(.+?)["']?\s*$/);
    if (match) env[match[1]] = match[2];
  });
} else {
  console.log('‚òÅÔ∏è  No .env file found ‚Äî reading from environment variables (Vercel/CI)');
}

// Env vars from file override, but fall back to process.env
const url = env.SUPABASE_URL || process.env.SUPABASE_URL;
const key = env.SUPABASE_ANON_KEY || process.env.SUPABASE_ANON_KEY;

if (!url || !key) {
  console.error('‚ùå SUPABASE_URL and SUPABASE_ANON_KEY must be set (in .env or environment variables)');
  process.exit(1);
}

// Write env.js (used by supabase-client.js via window globals)
const envContent = `// Auto-generated by generate-config.js. Do not edit manually.
// Contains only the public anon key (safe to expose).
window.__SUPABASE_URL = '${url}'
window.__SUPABASE_ANON_KEY = '${key}';
`;

const envOutPath = path.join(__dirname, '..', 'Frontend', 'js', 'env.js');
fs.writeFileSync(envOutPath, envContent);
console.log('‚úÖ Frontend/js/env.js generated from .env');

// Write config.js (Gemini key etc.)
const geminiKey = env.GEMINI_API_KEY || process.env.GEMINI_API_KEY || '';
const configContent = `// AUTO-GENERATED ‚Äî do not edit, do not commit
// Run "npm run config" to regenerate from .env
GEMINI_API_KEY = "${geminiKey}";
`;

const outPath = path.join(__dirname, '..', 'Frontend', 'js', 'config.js');
fs.writeFileSync(outPath, configContent);
console.log('‚úÖ Frontend/js/config.js generated from .env');
